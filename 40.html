<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  
  

  
  <!-- See: http://trac.edgewall.org/wiki/TracInterfaceCustomization -->


  <head>
    <title>
      #40 (AVI writer produces incorrect video files)
     – LOCI Software
    </title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <link rel="stylesheet" href="trac.css" type="text/css" /><link rel="stylesheet" href="ticket.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="style.css" />
  </head>
  <body>
    <div id="main">
    <div id="notice" style="width: 58em; max-width: 100%; margin-left: auto; margin-right: auto; border: 1px solid black; margin-bottom: 2em">
      <table>
        <tr>
          <td style="font-size: 72px; color: firebrick; padding: 0 10px 0 10px">&#9888;</td>
          <td>
            <p style="margin: 0.4em">
            NOTICE! This is a static HTML version of a legacy LOCI Software ticket.
            </p>
            <p style="margin: 0.4em">
            LOCI projects are now located
            <a href="https://github.com/uw-loci">on GitHub</a>.
            The Bio-Formats project can be found
            <a href="https://github.com/openmicroscopy/bioformats">here</a>.
            </p>
          </td>
        </tr>
      </table>
    </div>
    <div id="content" class="ticket">
      <h1 id="trac-ticket-title">
          <a href="40.html">Ticket #40</a>
          <span class="status">(closed defect: fixed)</span>
      </h1>
      <div id="ticket">
  <div class="date">
    <p>Opened 2007-03-19T12:12:50-05:00</p>
    <p>Last modified 2007-03-22T09:25:21-05:00</p>
  </div>
  <h2 class="summary searchable">AVI writer produces incorrect video files</h2>
  <table class="properties">
    <tr>
      <th id="h_reporter">Reported by:</th>
      <td headers="h_reporter" class="searchable">
        curtis
      </td>
      <th id="h_owner">Owned by:</th>
      <td headers="h_owner">
        melissa
      </td>
    </tr>
    <tr>
        <th id="h_priority">
          Priority:
        </th>
        <td headers="h_priority">
              minor
        </td>
        <th id="h_milestone">
          Milestone:
        </th>
        <td headers="h_milestone">
              <a class="missing milestone"></a>
        </td>
    </tr><tr>
        <th id="h_component">
          Component:
        </th>
        <td headers="h_component">
              bio-formats
        </td>
        <th id="h_severity">
          Severity:
        </th>
        <td headers="h_severity">
              
        </td>
    </tr><tr>
        <th id="h_keywords">
          Keywords:
        </th>
        <td headers="h_keywords" class="searchable">
        </td>
        <th id="h_cc">
          Cc:
        </th>
        <td headers="h_cc" class="searchable">
        </td>
    </tr><tr>
        <th id="h_blockedby">
          Blocked By:
        </th>
        <td headers="h_blockedby">
        </td>
        <th id="h_blocking">
          Blocking:
        </th>
        <td headers="h_blocking">
        </td>
    </tr>
  </table>
  <div class="description">
    <h3 id="comment:description">
      Description
      <span class="lastmod" title="2007-03-19 17:13:44+00:00">
        (last modified by curtis)
      </span>
    </h3>
    <div class="searchable">
      <p>
The AVI writer sometimes produces videos that are skewed or scrambled. The code was originally adapted from the ImageJ <tt>AVI_Writer</tt> plugin, which does not seem to suffer from the problem (though I have not recently verified that it works properly either). I have compared the two implementations, but was unable to determine what would cause this discrepancy, so the bug is something of a mystery.
</p>
<p>
For an example, open <tt>data/tiff/mri-stack.tif</tt> into the Bio-Formats viewer, and File&gt;Save to <tt>mri-stack.avi</tt>. The video file will be extremely skewed with many video players (I tested in Totem with the totem-gstreamer engine). The video will appear more reasonable when opened with the Bio-Formats Importer, but still slightly corrupted, especially towards the later frames at the top of the image.
</p>

    </div>
  </div>
</div>
          
    <div id="attachments">
        <h2 class="foldable">Attachments</h2>
        <div>
          <dl class="attachments">
              <dt>
    <a href="attach/40/gspot.jpg">gspot.jpg</a>
       (<span title="186483 bytes">182.1 KB</span>) -
      added by <em>curtis</em> 2007-03-21T13:33:29-05:00.
  </dt>
              <dd>
                Comparison of video encoded with ImageJ vs Bio-Formats in GSpot codec identification software
              </dd>
          </dl>
          
        </div>
    </div>

        <div>
          <h2 class="foldable">Change History</h2>
          <div id="changelog">
              <div class="change" id="trac-change-1">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:1" class="cnum">
      <a href="#comment:1">comment:1</a>
    </span>
                  </span>
                  Changed 2007-03-19T12:13:44-05:00 by curtis
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Description</strong>
        modified
    </li>
  </ul>
    <div class="comment searchable">
      
      
    </div>

              </div>
              <div class="change" id="trac-change-2">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:2" class="cnum">
      <a href="#comment:2">comment:2</a>
    </span>
                  </span>
                  Changed 2007-03-19T15:25:20-05:00 by melissa
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>new</em> to <em>closed</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
This was a bug in the AVI reader (not the writer); see <a class="changeset" href="/trac/software/changeset/2483" title="Fixed AVI reader bug; simplified some logic in the AVI writer.
">r2483</a>.
</p>
<p>
Totem (xine engine) still does not display the AVI file generated from data/tiff/mri-stack.tif (using Bio-Formats or AVI_Writer).  However, the following movie players display this file correctly:
</p>
<p>
Bio-Formats<br />
mplayer<br />
xine<br />
QuickTime (on Mac OS X)
</p>
<p>
Seems to me like this is a bug in Totem, but feel free to reopen if I'm missing something.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-3">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:3" class="cnum">
      <a href="#comment:3">comment:3</a>
    </span>
                  </span>
                  Changed 2007-03-21T10:08:48-05:00 by curtis
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Priority</strong>
        changed from <em>major</em> to <em>minor</em>
    </li><li>
      <strong>Status</strong>
        changed from <em>closed</em> to <em>reopened</em>
    </li><li>
      <strong>Resolution</strong>
        <em>fixed</em> deleted
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
I tested with ImageJ's <a class="ext-link" href="http://rsb.info.nih.gov/ij/plugins/avi.html"><span class="icon"> </span>AVI Writer</a> plugin, and it produces a different file than Bio-Formats does with the same input data. In particular, the ImageJ-produced video plays properly in Windows Media Player, while the Bio-Formats-produced video does not.
</p>
<p>
I have placed the two files in <tt>data/curtis/avi</tt> for comparison. I also added a (crappy) binary diff utility at <a class="source" href="/trac/software/browser/trunk/loci/utils/BinaryDiff.java">source:trunk/loci/utils/BinaryDiff.java</a> that does dumb byte comparison and outputs the differences. Running it on the two AVI files produces a long list of mostly off-by-1s -- maybe there is a difference in rounding somewhere? Probably the first few lines of output are the most interesting and useful.
</p>
<p>
Still, both videos look scrambled with totem (including the GNOME preview, which by default uses totem to generate the thumbnails). So there seem to be two separate problems here:
</p>
<ol><li>Scrambled video in Totem.
</li><li>Video does not play in Windows Media Player.
</li></ol><p>
The first problem could indeed be a bug in Totem. I know the videos appear incorrectly with totem-gstreamer installed. You said the BF video is also scrambled in totem-xine? If so, that does point to Totem, but I have seen many AVI thumbnails rendered with Totem, and never seen another scrambled one, leading me to believe there is something subtly wrong or at least unusual about the ImageJ and Bio-Formats AVI encoders.
</p>
<p>
The second problem is most certainly a problem, since ImageJ produces videos that work properly in Media Player.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-4">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:4" class="cnum">
      <a href="#comment:4">comment:4</a>
    </span>
                  </span>
                  Changed 2007-03-21T10:20:24-05:00 by curtis
                </h3>
                
    <div class="comment searchable">
      
      <p>
Upon further investigation, the AVI_Writer plugin available from the ImageJ web site is out of date. It has since been factored into the ImageJ core. I created a third AVI with the newest version of ImageJ, and this video does <em>not</em> suffer from the Totem skew problem. There are only three bytes different between it and the AVI_Writer video, so it should be very easy to figure out how to eliminate the skew problem from the Bio-Formats AVI writer.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-5">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:5" class="cnum">
      <a href="#comment:5">comment:5</a>
    </span>
                  </span>
                  Changed 2007-03-21T11:45:55-05:00 by melissa
                </h3>
                
    <div class="comment searchable">
      
      <p>
<a class="changeset" href="/trac/software/changeset/2491" title="Fixed bug that caused skewing in Totem.
">r2491</a> should fix the skewing problem in Totem (totem-xine, that is).  The issue was that the Bio-Formats AVI writer recorded the actual width of each plane, when it needed to record the padded width (a multiple of four).  The old AVI_Writer plugin does the same thing.
</p>
<p>
I can't test with Windows Media Player, but I'm guessing Bio-Formats AVI files will now open correctly.
</p>

    </div>

              </div>
              <div class="change">
                <h3 class="change">
                  Changed 2007-03-21T13:33:29-05:00 by curtis
                </h3>
                
  <ul class="changes">
    <li>
      <strong>attachment</strong>
        <a href="attach/40/gspot.jpg"><em>gspot.jpg</em></a>
          added
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Comparison of video encoded with ImageJ vs Bio-Formats in GSpot codec identification software
</p>

    </div>

              </div>
              <div class="change" id="trac-change-6">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:6" class="cnum">
      <a href="#comment:6">comment:6</a>
    </span>
                  </span>
                  Changed 2007-03-21T13:38:58-05:00 by curtis
                </h3>
                
    <div class="comment searchable">
      
      <p>
Great, the skewing problem is fixed in totem-gstreamer as well. I replaced the Bio-Formats-encoded video at <tt>data/avi/curtis/mri-stack-bf.avi</tt> with a new version reflecting the fix.
</p>
<p>
However, the Bio-Formats video still does not play in Media Player, nor can Windows XP create a thumbnail. Both ImageJ-encoded videos, old and new, do have thumbnails. So something is different about the Bio-Formats encoder.
</p>
<p>
I tried reading the new ImageJ video and the Bio-Formats video into the <a class="ext-link" href="http://www.headbands.com/gspot/"><span class="icon"> </span>GSpot</a> codec information and identification software, and it reports that <tt>mri-stack-bf.avi</tt> has a bad AVI header at offset 0x0ff8. See the attachment for a screenshot.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-7">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:7" class="cnum">
      <a href="#comment:7">comment:7</a>
    </span>
                  </span>
                  Changed 2007-03-21T14:34:49-05:00 by melissa
                </h3>
                
    <div class="comment searchable">
      
      <p>
Files produced using <a class="changeset" href="/trac/software/changeset/2492" title="Fixed bug causing corrupt files to be written.
">r2492</a> look fine in GSpot.  data/avi/curtis/mri-stack-bf.avi has been replaced to reflect this fix.
</p>

    </div>

              </div>
              <div class="change" id="trac-change-8">
                <h3 class="change">
                  <span class="threading">
                    <span id="comment:8" class="cnum">
      <a href="#comment:8">comment:8</a>
    </span>
                  </span>
                  Changed 2007-03-22T09:25:21-05:00 by curtis
                </h3>
                
  <ul class="changes">
    <li>
      <strong>Status</strong>
        changed from <em>reopened</em> to <em>closed</em>
    </li><li>
      <strong>Resolution</strong>
        set to <em>fixed</em>
    </li>
  </ul>
    <div class="comment searchable">
      
      <p>
Woo, it plays in Media Player, too.
</p>

    </div>

              </div>
          </div>
        </div>
    </div>
    </div>
  </body>
</html>
